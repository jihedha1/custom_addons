<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================== -->
    <!-- VUE LISTE DES R√âPONSES EN ATTENTE -->
    <!-- ================================================================== -->
    <record id="view_pending_answers_tree" model="ir.ui.view">
        <field name="name">slide.question.pending.answer.tree</field>
        <field name="model">slide.question.pending.answer</field>
        <field name="arch" type="xml">
            <tree decoration-info="state == 'pending'"
                  decoration-success="state == 'validated'"
                  decoration-danger="state == 'rejected'"
                  decoration-muted="state == 'corrected'"
                  decoration-warning="is_overdue == True"
                  editable="top">

                <field name="create_date" string="Date" widget="datetime"/>
                <field name="student_name" string="√âtudiant"/>
                <field name="channel_id" string="Cours" optional="show"/>
                <field name="slide_id" string="Chapitre" optional="show"/>
                <field name="question_text" string="Question" optional="hide"/>
                <field name="text_answer" string="R√©ponse" optional="hide"/>
                <field name="answer_id" string="Choix" optional="hide"/>

                <field name="score" string="Score Sugg√©r√©"
                       widget="progressbar"
                       decoration-success="score &gt;= 80"
                       decoration-warning="score &gt;= 50 and score &lt; 80"
                       decoration-danger="score &lt; 50"/>

                <field name="final_score" string="Score Final"
                       optional="hide"
                       invisible="state == 'pending'"/>

                <field name="is_overdue" string="En retard" invisible="1"/>
                <field name="processing_time" string="Temps (h)"
                       optional="hide"
                       invisible="state == 'pending'"
                       widget="float_time"/>

                <field name="state" widget="badge"
                       decoration-info="state == 'pending'"
                       decoration-success="state == 'validated'"
                       decoration-danger="state == 'rejected'"
                       decoration-muted="state == 'corrected'"/>

                <field name="validated_by" string="Valid√© par" optional="hide"/>

                <!-- Actions rapides -->
                <button name="action_validate"
                        string="‚úì Valider"
                        type="object"
                        class="btn-success"
                        title="Accepter la suggestion"
                        invisible="state != 'pending'"/>

                <button name="action_correct_manually"
                        string="‚úèÔ∏è Corriger"
                        type="object"
                        class="btn-warning"
                        title="Ouvrir l'assistant de correction"
                        invisible="state != 'pending'"/>

                <button name="action_reject"
                        string="‚úï Rejeter"
                        type="object"
                        class="btn-danger"
                        title="Rejeter la r√©ponse"
                        invisible="state != 'pending'"
                        confirm="Rejeter cette r√©ponse ? Le score sera de 0."/>

            </tree>
        </field>
    </record>

    <!-- ================================================================== -->
    <!-- VUE FORMULAIRE DES R√âPONSES EN ATTENTE -->
    <!-- ================================================================== -->
    <record id="view_pending_answers_form" model="ir.ui.view">
        <field name="name">slide.question.pending.answer.form</field>
        <field name="model">slide.question.pending.answer</field>
        <field name="arch" type="xml">
            <form string="Validation de R√©ponse">
                <header>
                    <button name="action_validate"
                            string="‚úì Valider la Correction"
                            type="object"
                            class="btn-success"
                            invisible="state != 'pending'"
                            help="Accepter la suggestion automatique"/>

                    <button name="action_correct_manually"
                            string="‚úèÔ∏è Modifier la Correction"
                            type="object"
                            class="btn-warning"
                            invisible="state != 'pending'"
                            help="Ouvrir l'assistant de correction manuelle"/>

                    <button name="action_reject"
                            string="‚úï Rejeter"
                            type="object"
                            class="btn-danger"
                            invisible="state != 'pending'"
                            confirm="Rejeter cette r√©ponse ? Le score sera de 0."/>

                    <field name="state" widget="statusbar"
                           statusbar_visible="pending,validated,corrected"/>
                </header>

                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_question"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-question-circle">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Voir la</span>
                                <span class="o_stat_text">Question</span>
                            </div>
                        </button>

                        <button name="action_view_student"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-user">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Profil</span>
                                <span class="o_stat_text">√âtudiant</span>
                            </div>
                        </button>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="display_name" readonly="1"/>
                        </h1>
                    </div>

                    <group>
                        <group string="üìå Informations">
                            <field name="question_id" readonly="1"/>
                            <field name="user_id" widget="many2one_avatar_user" readonly="1"/>
                            <field name="channel_id" readonly="1"/>
                            <field name="slide_id" readonly="1"/>
                            <field name="create_date" readonly="1"/>
                            <field name="is_overdue" invisible="1"/>
                        </group>

                        <group string="ü§ñ R√©sultat Sugg√©r√©">
                            <field name="is_correct" readonly="1"
                                   widget="boolean_toggle"/>
                            <field name="score" readonly="1"
                                   widget="progressbar"/>
                            <field name="processing_time" readonly="1"
                                   invisible="state == 'pending'"
                                   widget="float_time"/>
                        </group>
                    </group>

                    <!-- Alertes -->
                    <div class="alert alert-warning" role="alert"
                         invisible="is_overdue != True or state != 'pending'">
                        <i class="fa fa-exclamation-triangle me-2" title="Attention" role="img"
                           aria-label="Attention"></i>
                        <strong>Attention :</strong>
                        Cette r√©ponse est en attente depuis plus de 48h !
                    </div>

                    <notebook>
                        <!-- Page 1 : R√©ponse de l'√âtudiant -->
                        <page string="üìù R√©ponse de l'√âtudiant" name="student_answer">

                            <group string="Question Pos√©e">
                                <field name="question_text" readonly="1"
                                       widget="html"
                                       nolabel="1"/>
                            </group>

                            <separator string="R√©ponse Soumise"/>

                            <!-- Pour QCM/Vrai-Faux -->
                            <group invisible="answer_id == False">
                                <field name="answer_id" readonly="1"
                                       widget="many2one"
                                       options="{'no_create': True, 'no_open': True}"/>
                            </group>

                            <!-- Pour Questions Ouvertes -->
                            <group invisible="text_answer == False">
                                <field name="text_answer" readonly="1"
                                       widget="text"
                                       nolabel="1"
                                       class="o_field_text"
                                       style="min-height: 100px;"/>
                            </group>

                        </page>

                        <!-- Page 2 : Feedback GPT (si disponible) -->
                        <page string="ü§ñ Analyse GPT"
                              name="gpt_feedback"
                              invisible="gpt_ideal_answer == False">

                            <div class="alert alert-info mb-3" role="alert">
                                <i class="fa fa-robot me-2" title="IA" role="img" aria-label="IA"></i>
                                <strong>Analyse effectu√©e par l'Intelligence Artificielle</strong>
                                <p class="mb-0 mt-2">
                                    Cette analyse a √©t√© g√©n√©r√©e automatiquement.
                                    Elle constitue une suggestion qui peut √™tre modifi√©e.
                                </p>
                            </div>

                            <group string="üìñ R√©ponse Id√©ale Sugg√©r√©e">
                                <field name="gpt_ideal_answer" readonly="1"
                                       widget="text"
                                       nolabel="1"/>
                            </group>

                            <separator string="Feedback G√©n√©r√©"/>

                            <field name="feedback" readonly="1"
                                   widget="html"
                                   nolabel="1"/>

                        </page>

                        <!-- Page 3 : Feedback Sugg√©r√© (sans GPT) -->
                        <page string="üí° Feedback Sugg√©r√©"
                              name="suggested_feedback"
                              invisible="gpt_ideal_answer != False">

                            <div class="alert alert-warning mb-3" role="alert">
                                <i class="fa fa-lightbulb-o me-2" title="Conseil" role="img" aria-label="Conseil"></i>
                                <strong>Correction Automatique (Mots-cl√©s)</strong>
                                <p class="mb-0 mt-2">
                                    Ce feedback a √©t√© g√©n√©r√© automatiquement sur la base
                                    des mots-cl√©s d√©finis pour cette question.
                                </p>
                            </div>

                            <field name="feedback" readonly="1"
                                   widget="html"
                                   nolabel="1"/>

                        </page>

                        <!-- Page 4 : Correction Finale (apr√®s validation) -->
                        <page string="‚úÖ Correction Finale"
                              name="final_correction"
                              invisible="state == 'pending'">

                            <div class="alert alert-success mb-3" role="alert"
                                 invisible="state != 'validated'">
                                <i class="fa fa-check-circle me-2" title="Valid√©" role="img" aria-label="Valid√©"></i>
                                <strong>Correction valid√©e</strong>
                                -
                                La suggestion automatique a √©t√© accept√©e.
                            </div>

                            <div class="alert alert-info mb-3" role="alert"
                                 invisible="state != 'corrected'">
                                <i class="fa fa-edit me-2" title="√âditer" role="img" aria-label="√âditer"></i>
                                <strong>Correction manuelle effectu√©e</strong>
                                -
                                Un enseignant a modifi√© la correction.
                            </div>

                            <div class="alert alert-danger mb-3" role="alert"
                                 invisible="state != 'rejected'">
                                <i class="fa fa-times-circle me-2" title="Rejeter" role="img" aria-label="Rejeter"></i>
                                <strong>R√©ponse rejet√©e</strong>
                            </div>

                            <group>
                                <group>
                                    <field name="final_score" readonly="1"
                                           widget="progressbar"/>
                                    <field name="validated_by" readonly="1"
                                           widget="many2one_avatar_user"/>
                                    <field name="validated_date" readonly="1"/>
                                </group>
                                <group>
                                    <field name="teacher_comment" readonly="1"
                                           invisible="teacher_comment == False"/>
                                </group>
                            </group>

                            <separator string="Feedback Final Envoy√© √† l'√âtudiant"/>

                            <field name="final_feedback" readonly="1"
                                   widget="html"
                                   nolabel="1"/>

                        </page>

                    </notebook>
                </sheet>

                <!-- Chatter pour historique -->
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="message_ids"/>
                </div>

            </form>
        </field>
    </record>

    <!-- ================================================================== -->
    <!-- VUE KANBAN -->
    <!-- ================================================================== -->
    <record id="view_pending_answers_kanban" model="ir.ui.view">
        <field name="name">slide.question.pending.answer.kanban</field>
        <field name="model">slide.question.pending.answer</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state"
                    class="o_kanban_small_column"
                    quick_create="false">

                <field name="state"/>
                <field name="score"/>
                <field name="is_overdue"/>
                <field name="student_name"/>
                <field name="question_text"/>

                <templates>
                    <t t-name="kanban-box">
                        <div class="oe_kanban_global_click">
                            <div class="o_kanban_record_top">
                                <div class="o_kanban_record_headings">
                                    <strong class="o_kanban_record_title">
                                        <field name="student_name"/>
                                    </strong>
                                    <br/>
                                    <span class="text-muted">
                                        <field name="create_date" widget="datetime"/>
                                    </span>
                                </div>
                                <div class="o_kanban_record_top_right">
                                    <div class="o_kanban_record_badges">
                                        <t t-if="record.is_overdue.raw_value">
                                            <span class="badge bg-warning">
                                                <i class="fa fa-clock-o"/>
                                                En retard
                                            </span>
                                        </t>
                                    </div>
                                </div>
                            </div>

                            <div class="o_kanban_record_body">
                                <div class="text-muted small text-truncate">
                                    <i class="fa fa-question-circle me-1" title="Question" role="img"
                                       aria-label="Question"></i>
                                    <field name="question_text"/>
                                </div>

                                <div class="mt-2">
                                    <div class="progress" style="height: 20px;">
                                        <div class="progress-bar"
                                             role="progressbar"
                                             t-attf-style="width: {{record.score.raw_value}}%;"
                                             t-attf-class="bg-{{record.score.raw_value >= 80 ? 'success' : record.score.raw_value >= 50 ? 'warning' : 'danger'}}">
                                            <t t-esc="record.score.raw_value"/>%
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="o_kanban_record_bottom" t-if="record.state.raw_value == 'pending'">
                                <div class="oe_kanban_bottom_left">
                                    <button name="action_validate"
                                            type="object"
                                            class="btn btn-sm btn-success">
                                        ‚úì Valider
                                    </button>
                                </div>
                                <div class="oe_kanban_bottom_right">
                                    <button name="action_correct_manually"
                                            type="object"
                                            class="btn btn-sm btn-warning">
                                        ‚úèÔ∏è Corriger
                                    </button>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- ================================================================== -->
    <!-- RECHERCHE ET FILTRES -->
    <!-- ================================================================== -->
    <record id="view_pending_answers_search" model="ir.ui.view">
        <field name="name">slide.question.pending.answer.search</field>
        <field name="model">slide.question.pending.answer</field>
        <field name="arch" type="xml">
            <search>
                <field name="student_name"/>
                <field name="question_id"/>
                <field name="channel_id"/>
                <field name="slide_id"/>
                <filter name="filter_pending"
                        string="En Attente"
                        domain="[('state', '=', 'pending')]"/>
                <filter name="filter_validated"
                        string="Valid√©es"
                        domain="[('state', '=', 'validated')]"/>
                <filter name="filter_corrected"
                        string="Corrig√©es Manuellement"
                        domain="[('state', '=', 'corrected')]"/>
                <filter name="filter_rejected"
                        string="Rejet√©es"
                        domain="[('state', '=', 'rejected')]"/>
                <separator/>

                <filter name="filter_overdue"
                        string="En Retard (&gt;48h)"
                        domain="[('is_overdue', '=', True)]"/>
                <filter name="filter_high_score"
                        string="Score √âlev√© (‚â•80)"
                        domain="[('score', '&gt;=', 80)]"/>
                <filter name="filter_low_score"
                        string="Score Faible (&lt;50)"
                        domain="[('score', '&lt;', 50)]"/>

                <separator/>

                <filter name="filter_today"
                        string="Aujourd'hui"
                        domain="[('create_date', '&gt;=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_week"
                        string="Cette Semaine"
                        domain="[('create_date', '&gt;=', (context_today() - relativedelta(weeks=1)).strftime('%Y-%m-%d'))]"/>

                <group expand="0" string="Grouper par">
                    <filter name="group_state"
                            string="√âtat"
                            context="{'group_by': 'state'}"/>
                    <filter name="group_course"
                            string="Cours"
                            context="{'group_by': 'channel_id'}"/>
                    <filter name="group_student"
                            string="√âtudiant"
                            context="{'group_by': 'user_id'}"/>
                    <filter name="group_date"
                            string="Date"
                            context="{'group_by': 'create_date:day'}"/>
                </group>
            </search>
        </field>
    </record>
    <!-- ================================================================== -->
    <!-- ACTIONS -->
    <!-- ================================================================== -->

    <!-- Action principale : Toutes les r√©ponses en attente -->
    <record id="action_pending_answers_all" model="ir.actions.act_window">
        <field name="name">R√©ponses √† Valider</field>
        <field name="res_model">slide.question.pending.answer</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="domain">[('state', '=', 'pending')]</field>  <!-- Retirer le filtre par enseignant -->
        <field name="context">{
            'search_default_filter_pending': 1,
            'search_default_group_state': 1
            }
        </field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Aucune r√©ponse en attente !
            </p>
            <p>
                Toutes les r√©ponses des √©tudiants ont √©t√© valid√©es.
            </p>
        </field>
    </record>
    <!-- Action : R√©ponses en retard -->
    <record id="action_pending_answers_overdue" model="ir.actions.act_window">
        <field name="name">R√©ponses en Retard (&gt;48h)</field>
        <field name="res_model">slide.question.pending.answer</field>
        <field name="view_mode">tree,kanban,form</field>
        <field name="domain">[('state', '=', 'pending'), ('is_overdue', '=', True)]
        </field>
        <field name="context">{'search_default_filter_overdue': 1}</field>
    </record>

    <!-- Action : Historique des corrections -->
    <record id="action_pending_answers_history" model="ir.actions.act_window">
        <field name="name">Historique des Corrections</field>
        <field name="res_model">slide.question.pending.answer</field>
        <field name="view_mode">tree,form</field>
        <field name="domain">[('state', 'in', ['validated', 'corrected', 'rejected'])]
        </field>  <!-- Retirer le filtre par enseignant -->
        <field name="context">{
            'search_default_group_date': 1
            }
        </field>
    </record>
</odoo>