<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ================================================================== -->
    <!-- OVERRIDE : FORMULAIRE DE QUESTION (Backend) -->
    <!-- Ajout des champs personnalisés dans le formulaire d'édition -->
    <!-- CORRECTION : Utilisation de 'invisible' au lieu de 't-if' -->
    <!-- ================================================================== -->
    <record id="slide_question_form_type" model="ir.ui.view">
        <field name="name">slide.question.form.type.extended</field>
        <field name="model">slide.question</field>
        <field name="inherit_id" ref="website_slides.slide_question_view_form"/>
        <field name="arch" type="xml">

            <!-- Bannière Info IA si question générée -->
            <xpath expr="//sheet" position="before">
                <div class="alert alert-info oe_read_only mx-3 mt-3 d-flex align-items-center"
                     role="alert"
                     invisible="x_ai_generated == False">
                    <i class="fa fa-robot fa-2x me-3" title="Intelligence Artificielle" role="img"
                       aria-label="Intelligence Artificielle"></i>
                    <div>
                        <h4 class="alert-heading mb-2">
                            <i class="fa fa-magic me-2" title="Magie" role="img" aria-label="Magie"></i>
                            Question générée par IA
                        </h4>
                        <p class="mb-0">
                            Cette question a été créée automatiquement par notre système d'intelligence artificielle.
                            Vous pouvez la modifier selon vos besoins.
                        </p>
                    </div>
                    <field name="x_ai_generated" invisible="1"/>
                </div>
            </xpath>

            <!-- Ajout du sélecteur de type après la question -->
            <xpath expr="//field[@name='question']" position="after">
                <field name="x_question_type"
                       widget="radio"
                       options="{'horizontal': true}"
                       required="1"/>

                <!-- Correction IA uniquement pour text_box -->
                <field name="is_ai_corrected"
                       invisible="x_question_type != 'text_box'"/>

                <!-- Info sur le mode de correction -->
                <div class="alert alert-info mb-0"
                     role="alert"
                     invisible="x_question_type != 'text_box' or is_ai_corrected == False">
                    <i class="fa fa-info-circle me-2" title="Information" role="img" aria-label="Information"></i>
                    <strong>Mode automatique :</strong>
                    La réponse sera corrigée instantanément par l'IA en utilisant les mots-clés définis.
                </div>

                <div class="alert alert-warning mb-0"
                     role="alert"
                     invisible="x_question_type != 'text_box' or is_ai_corrected == True">
                    <i class="fa fa-user me-2" title="Utilisateur" role="img" aria-label="Utilisateur"></i>
                    <strong>Mode manuel :</strong>
                    La réponse sera mise en attente pour validation enseignant.
                    L'IA peut pré-analyser la réponse si configurée.
                </div>
            </xpath>

            <!-- Masquer answer_ids pour les questions ouvertes -->
            <xpath expr="//field[@name='answer_ids']" position="attributes">
                <attribute name="invisible">x_question_type == 'text_box'</attribute>
            </xpath>

            <!-- Label explicatif pour les réponses -->
            <xpath expr="//field[@name='answer_ids']" position="before">
                <div class="alert alert-primary mb-2"
                     role="alert"
                     invisible="x_question_type == 'text_box'">
                    <i class="fa fa-lightbulb-o me-2" title="Conseil" role="img" aria-label="Conseil"></i>
                    <strong invisible="x_question_type != 'simple_choice'">
                        Définissez les réponses possibles. Cochez "Est correct" pour la ou les bonnes réponses.
                    </strong>
                    <strong invisible="x_question_type != 'true_false'">
                        Créez exactement 2 réponses : "Vrai" et "Faux". Cochez la bonne réponse.
                    </strong>
                </div>
            </xpath>

        </field>
    </record>

    <!-- ================================================================== -->
    <!-- TEMPLATE PRINCIPAL : PAGE QUIZ STANDALONE -->
    <!-- Appelé directement depuis le contrôleur main.py -->
    <!-- ================================================================== -->
    <template id="quiz_page_custom" name="Custom Quiz Page">
        <t t-call="website.layout">
            <!-- Inclure les styles inline -->
            <t t-call="odoo_gpt_integration.quiz_inline_styles"/>

            <div id="wrap" class="o_wslides_lesson_main">
                <div class="container my-5">

                    <!-- Breadcrumb Navigation -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <nav aria-label="breadcrumb">
                                <ol class="breadcrumb">
                                    <li class="breadcrumb-item">
                                        <a t-att-href="'/slides/%s' % slug(slide.channel_id)">
                                            <i class="fa fa-home me-2"></i>
                                            <span t-field="slide.channel_id.name"/>
                                        </a>
                                    </li>
                                    <li class="breadcrumb-item active" aria-current="page">
                                        <i class="fa fa-graduation-cap me-2"></i>
                                        <span t-field="slide.name"/>
                                    </li>
                                </ol>
                            </nav>
                        </div>
                    </div>

                    <!-- Contenu du Quiz -->
                    <div class="row">
                        <div class="col-lg-10 col-xl-9 mx-auto">
                            <t t-call="odoo_gpt_integration.quiz_content_only"/>
                        </div>
                    </div>

                </div>
            </div>
        </t>
    </template>

    <!-- ================================================================== -->
    <!-- TEMPLATE : CONTENU DU QUIZ (RÉUTILISABLE) -->
    <!-- Support complet des 3 types de questions -->
    <!-- ================================================================== -->
    <template id="quiz_content_only" name="Quiz Content Only">
        <div class="o_wslides_lesson_content_type_quiz"
             t-att-data-slide-id="slide.id">

            <!-- En-tête du Quiz -->
            <div class="card border-0 shadow-lg mb-4">
                <div class="card-header bg-primary text-white py-4">
                    <div class="d-flex align-items-center justify-content-between">
                        <h1 class="mb-0 h3">
                            <i class="fa fa-graduation-cap me-3"></i>
                            <span t-field="slide.name"/>
                        </h1>
                        <span class="badge bg-light text-primary fs-6">
                            Quiz
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-0 d-flex align-items-start" role="alert">
                        <i class="fa fa-info-circle fa-2x me-3 mt-1"></i>
                        <div>
                            <h5 class="alert-heading mb-2">Instructions</h5>
                            <p class="mb-2">
                                Répondez à toutes les questions ci-dessous puis cliquez sur
                                <strong>"Soumettre mes réponses"</strong>.
                            </p>
                            <ul class="mb-0 ps-3">
                                <li>Les questions avec <span class="badge bg-info">IA</span> sont corrigées
                                    automatiquement
                                </li>
                                <li>Certaines réponses peuvent nécessiter une validation enseignant</li>
                                <li>Prenez votre temps et réfléchissez bien avant de soumettre</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Formulaire du Quiz -->
            <form class="o_wslides_quiz_form">

                <!-- Affichage des Questions -->
                <t t-foreach="slide.question_ids" t-as="question">
                    <t t-set="question_number" t-value="question_index + 1"/>
                    <t t-set="qtype" t-value="question.x_question_type or 'simple_choice'"/>

                    <!-- Carte Question -->
                    <div t-attf-class="card mb-4 slide-question shadow-sm question-{{qtype}}"
                         t-att-data-question-id="question.id"
                         t-att-data-question-type="qtype">

                        <!-- En-tête Question -->
                        <div class="card-header bg-light">
                            <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
                                <h5 class="question-title mb-0 flex-grow-1">
                                    <span class="question-number badge bg-primary">
                                        Question
                                        <t t-esc="question_number"/>
                                    </span>
                                    <span t-field="question.question"/>
                                </h5>

                                <!-- Badges Informatifs -->
                                <div class="d-flex gap-2 flex-shrink-0">
                                    <!-- Badge Type -->
                                    <span t-if="qtype == 'simple_choice'"
                                          class="badge bg-secondary"
                                          title="Question à choix multiple">
                                        <i class="fa fa-list-ul"></i>
                                        QCM
                                    </span>
                                    <span t-elif="qtype == 'true_false'"
                                          class="badge bg-secondary"
                                          title="Question Vrai/Faux">
                                        <i class="fa fa-check-square-o"></i>
                                        V/F
                                    </span>
                                    <span t-else=""
                                          class="badge bg-secondary"
                                          title="Question ouverte">
                                        <i class="fa fa-edit"></i>
                                        Ouverte
                                    </span>

                                    <!-- Badge IA -->
                                    <t t-if="question.x_ai_generated">
                                        <span class="badge bg-info" title="Question générée par IA">
                                            <i class="fa fa-magic"></i>
                                            IA
                                        </span>
                                    </t>

                                    <!-- Badge Difficulté -->
                                    <t t-if="question.x_ai_difficulty_calculated">
                                        <span t-attf-class="badge {{
                                            'bg-success' if question.x_ai_difficulty_calculated == 'easy'
                                            else 'bg-warning text-dark' if question.x_ai_difficulty_calculated == 'medium'
                                            else 'bg-danger'
                                        }}" t-attf-title="Difficulté: {{
                                            'Facile' if question.x_ai_difficulty_calculated == 'easy'
                                            else 'Moyen' if question.x_ai_difficulty_calculated == 'medium'
                                            else 'Difficile'
                                        }}">
                                            <i class="fa fa-signal"></i>
                                            <t t-if="question.x_ai_difficulty_calculated == 'easy'">Facile</t>
                                            <t t-elif="question.x_ai_difficulty_calculated == 'medium'">Moyen</t>
                                            <t t-else="">Difficile</t>
                                        </span>
                                    </t>

                                    <!-- Badge Correction -->
                                    <t t-if="qtype == 'text_box'">
                                        <span t-if="question.is_ai_corrected"
                                              class="badge bg-primary"
                                              title="Correction automatique par IA">
                                            <i class="fa fa-robot"></i>
                                            Auto
                                        </span>
                                        <span t-else=""
                                              class="badge bg-warning text-dark"
                                              title="Correction manuelle par enseignant">
                                            <i class="fa fa-user"></i>
                                            Manuel
                                        </span>
                                    </t>
                                </div>
                            </div>
                        </div>

                        <!-- Corps de la Question -->
                        <div class="card-body">

                            <!-- TYPE 1: QCM Simple Choice -->
                            <t t-if="qtype == 'simple_choice'">
                                <div class="list-group list-group-flush">
                                    <t t-foreach="question.answer_ids" t-as="answer">
                                        <label t-attf-class="list-group-item list-group-item-action d-flex align-items-center"
                                               t-attf-for="answer_{{answer.id}}"
                                               style="cursor: pointer;">
                                            <input type="radio"
                                                   class="form-check-input me-3 question-answer flex-shrink-0"
                                                   t-attf-name="answer_ids_{{question.id}}"
                                                   t-attf-id="answer_{{answer.id}}"
                                                   t-attf-value="{{answer.id}}"/>
                                            <span class="flex-grow-1" t-field="answer.text_value"/>
                                        </label>
                                    </t>
                                </div>
                            </t>

                            <!-- TYPE 2: Vrai/Faux -->
                            <t t-elif="qtype == 'true_false'">
                                <div class="btn-group-toggle" data-toggle="buttons">
                                    <t t-foreach="question.answer_ids" t-as="answer">
                                        <input type="radio"
                                               class="btn-check question-answer"
                                               t-attf-name="answer_ids_{{question.id}}"
                                               t-attf-id="answer_tf_{{answer.id}}"
                                               t-attf-value="{{answer.id}}"
                                               autocomplete="off"/>
                                        <label class="btn btn-outline-primary"
                                               t-attf-for="answer_tf_{{answer.id}}">
                                            <i t-if="answer.text_value and 'Vrai' in answer.text_value"
                                               class="fa fa-check-circle"></i>
                                            <i t-elif="answer.text_value and 'Faux' in answer.text_value"
                                               class="fa fa-times-circle"></i>
                                            <span t-field="answer.text_value"/>
                                        </label>
                                    </t>
                                </div>
                            </t>

                            <!-- TYPE 3: Question Ouverte -->
                            <t t-elif="qtype == 'text_box'">
                                <div class="question-openended">
                                    <textarea class="form-control question-text-answer"
                                              t-attf-id="text_answer_{{question.id}}"
                                              t-attf-name="text_answer_{{question.id}}"
                                              rows="8"
                                              placeholder="Écrivez votre réponse ici... Soyez précis et détaillé."
                                              t-att-data-ai-enabled="'true' if question.is_ai_corrected else 'false'"></textarea>

                                    <!-- Info Mode Correction -->
                                    <t t-if="question.is_ai_corrected">
                                        <div class="alert alert-info mt-3 mb-0 d-flex align-items-center" role="alert">
                                            <i class="fa fa-robot fa-lg me-3"></i>
                                            <div>
                                                <strong>Correction automatique</strong>
                                                <p class="mb-0 small">
                                                    Cette question sera corrigée instantanément par notre système
                                                    d'intelligence artificielle.
                                                </p>
                                            </div>
                                        </div>

                                        <!-- Feedback IA en Temps Réel -->
                                        <div class="ai-feedback-live mt-3" style="display: none;">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <strong class="text-muted">
                                                    <i class="fa fa-tachometer me-2"></i>
                                                    Analyse en direct
                                                </strong>
                                                <span class="badge bg-secondary progress-text">0%</span>
                                            </div>
                                            <div class="progress" style="height: 28px;">
                                                <div class="progress-bar bg-secondary"
                                                     role="progressbar"
                                                     style="width: 0%;"
                                                     aria-valuenow="0"
                                                     aria-valuemin="0"
                                                     aria-valuemax="100">
                                                </div>
                                            </div>
                                            <div class="feedback-message mt-2"></div>
                                        </div>
                                    </t>
                                    <t t-else="">
                                        <div class="alert alert-warning mt-3 mb-0 d-flex align-items-center"
                                             role="alert">
                                            <i class="fa fa-user fa-lg me-3"></i>
                                            <div>
                                                <strong>Correction manuelle</strong>
                                                <p class="mb-0 small">
                                                    Cette question sera corrigée par votre enseignant.
                                                    Vous recevrez une notification avec le résultat.
                                                </p>
                                            </div>
                                        </div>
                                    </t>
                                </div>
                            </t>

                            <!-- Fallback : Type Non Supporté -->
                            <t t-else="">
                                <div class="alert alert-danger mb-0" role="alert">
                                    <i class="fa fa-exclamation-triangle me-2"></i>
                                    <strong>Erreur :</strong>
                                    Type de question non supporté
                                    (<code t-esc="qtype"/>)
                                </div>
                            </t>

                            <!-- Bouton Indice (optionnel) -->
                            <div class="mt-3 text-end">
                                <button type="button"
                                        class="btn btn-sm btn-outline-secondary btn-show-hint"
                                        t-att-data-question-id="question.id">
                                    <i class="fa fa-lightbulb-o me-1"></i>
                                    Afficher un indice
                                </button>
                            </div>
                        </div>

                        <!-- Footer : Zone de Feedback (cachée initialement) -->
                        <div class="card-footer question-feedback" style="display: none;"></div>

                    </div>
                </t>

                <!-- Bouton de Soumission -->
                <div class="text-center my-5">
                    <button type="button"
                            class="btn btn-primary btn-lg px-5 py-3 o_wslides_quiz_submit shadow">
                        <i class="fa fa-check-circle me-2"></i>
                        Soumettre mes réponses
                    </button>
                    <p class="text-muted mt-3 mb-0">
                        <i class="fa fa-info-circle me-1"></i>
                        Assurez-vous d'avoir répondu à toutes les questions avant de soumettre
                    </p>
                </div>

            </form>

            <!-- Zone des Résultats (affichée après soumission) -->
            <div class="quiz-results-container" style="display: none;"></div>

        </div>
    </template>

    <!-- ================================================================== -->
    <!-- STYLES CSS INLINE -->
    <!-- Inclus directement dans les pages pour éviter les dépendances -->
    <!-- ================================================================== -->
    <template id="quiz_inline_styles" name="Quiz Inline Styles">
        <style>
            /* Questions */
            .slide-question {
            transition: all 0.3s ease;
            border-width: 2px;
            }
            .slide-question:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
            }

            /* QCM */
            .list-group-item-action {
            transition: all 0.2s ease;
            }
            .list-group-item-action:hover {
            background-color: #e7f1ff !important;
            border-color: #0d6efd !important;
            transform: translateX(4px);
            }
            .list-group-item:has(input:checked) {
            background-color: #cfe2ff !important;
            border-color: #0d6efd !important;
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
            }

            /* Vrai/Faux */
            .btn-check:checked + label {
            background-color: #0d6efd !important;
            border-color: #0d6efd !important;
            color: white !important;
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,.5);
            transform: scale(1.05);
            }
            .btn-check:focus + label {
            box-shadow: 0 0 0 0.2rem rgba(13,110,253,.25);
            }
            .btn-outline-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,.075);
            }

            /* Textarea */
            .question-text-answer {
            border: 2px solid #ced4da;
            font-size: 1rem;
            font-family: inherit;
            transition: all 0.2s ease;
            resize: vertical;
            }
            .question-text-answer:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13,110,253,.25);
            outline: 0;
            }

            /* Progress IA */
            .ai-feedback-live {
            animation: fadeIn 0.4s ease;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            }
            .ai-feedback-live .progress-bar {
            transition: width 0.5s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }

            /* Animations */
            @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
            }
            @keyframes fadeInUp {
            from {
            opacity: 0;
            transform: translateY(20px);
            }
            to {
            opacity: 1;
            transform: translateY(0);
            }
            }
            .question-feedback {
            animation: fadeInUp 0.5s ease-out;
            }

            /* Loader */
            .quiz-loader {
            background-color: rgba(255,255,255,0.95);
            border-radius: 0.75rem;
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15);
            }
            @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
            }
            .quiz-loader i {
            animation: pulse 1.5s infinite;
            }

            /* Bouton Submit */
            .o_wslides_quiz_submit:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.15) !important;
            }
            .o_wslides_quiz_submit:active:not(:disabled) {
            transform: translateY(0);
            }

            /* Score Display */
            .score-display .display-4 {
            background: linear-gradient(135deg, #0d6efd 0%, #0a58ca 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            }

            /* Responsive */
            @media (max-width: 768px) {
            .btn-group-toggle {
            display: grid !important;
            grid-template-columns: 1fr !important;
            gap: 0.75rem;
            }
            .question-title {
            font-size: 1.1rem !important;
            }
            .o_wslides_quiz_submit {
            width: 100%;
            padding: 0.75rem 2rem !important;
            }
            }
        </style>
    </template>
    <!-- ================================================================== -->
    <!-- TEMPLATE : MES RÉSULTATS (Page étudiant) -->
    <!-- Ajout du template manquant pour la route /slides/my_results -->
    <!-- ================================================================== -->

</odoo>