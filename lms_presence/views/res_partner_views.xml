<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- Extension du formulaire Contact/Partner -->
        <record id="view_partner_form_presence" model="ir.ui.view">
            <field name="name">res.partner.form.presence</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_partner_form"/>
            <field name="priority">100</field>
            <field name="arch" type="xml">

                <!-- Bouton statistique présence -->
                <xpath expr="//div[@name='button_box']" position="inside">
                    <button class="oe_stat_button" type="object"
                            name="action_view_attendances"
                            icon="fa-calendar-check-o"
                            invisible="attendance_count == 0">
                        <field string="Présences" name="attendance_count" widget="statinfo"/>
                    </button>
                </xpath>

                <!-- Onglet Formation -->
                <xpath expr="//page[@name='internal_notes']" position="after">
                    <page string="Formation" name="training_info">

                        <!-- Section Participant -->
                        <group string="Statut participant">
                            <group>
                                <field name="is_training_participant"/>
                            </group>
                            <group>
                                <field name="presence_rate" widget="progressbar"
                                       invisible="not is_training_participant"/>
                            </group>
                        </group>

                        <!-- Section Handicap -->
                        <group string="Accessibilité et handicap"
                               invisible="not is_training_participant">
                            <group>
                                <field name="has_disability"/>
                                <field name="disability_type"
                                       invisible="not has_disability"/>
                            </group>
                            <group>
                                <field name="disability_description"
                                       invisible="not has_disability"
                                       placeholder="Décrivez les aménagements nécessaires..."/>
                            </group>
                        </group>

                        <!-- Pièces jointes handicap -->
                        <group string="Justificatifs"
                               invisible="not has_disability"
                               col="1">
                            <field name="disability_attachment_ids"
                                   widget="many2many_binary"
                                   nolabel="1"/>
                        </group>

                        <!-- Section Contact urgence -->
                        <group string="Contact d'urgence"
                               invisible="not is_training_participant">
                            <group>
                                <field name="emergency_contact"
                                       placeholder="Nom du contact"/>
                            </group>
                            <group>
                                <field name="emergency_phone"
                                       widget="phone"
                                       placeholder="Numéro de téléphone"/>
                            </group>
                        </group>

                        <!-- Historique présences -->
                        <group string="Historique de présence"
                               invisible="not is_training_participant or attendance_count == 0"
                               col="1">
                            <field name="attendance_line_ids" nolabel="1" readonly="1">
                                <tree>
                                    <field name="session_name"/>
                                    <field name="session_date_start"/>
                                    <field name="state" widget="badge"
                                           decoration-success="state == 'present'"
                                           decoration-warning="state == 'late'"
                                           decoration-danger="state == 'absent'"
                                           decoration-info="state == 'excused'"/>
                                    <field name="check_in"/>
                                    <field name="check_out"/>
                                    <field name="validated_by_participant" widget="boolean"/>
                                    <field name="validated_by_teacher" widget="boolean"/>
                                </tree>
                            </field>
                        </group>

                    </page>
                </xpath>

            </field>
        </record>

        <!-- Extension de la liste des contacts -->
        <record id="view_partner_tree_presence" model="ir.ui.view">
            <field name="name">res.partner.tree.presence</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_partner_tree"/>
            <field name="priority">100</field>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='email']" position="after">
                    <field name="is_training_participant" optional="hide"/>
                    <field name="has_disability" optional="hide"/>
                    <field name="attendance_count" optional="hide"/>
                </xpath>
            </field>
        </record>

        <!-- Filtre pour les participants -->
        <record id="view_partner_search_presence" model="ir.ui.view">
            <field name="name">res.partner.search.presence</field>
            <field name="model">res.partner</field>
            <field name="inherit_id" ref="base.view_res_partner_filter"/>
            <field name="priority">100</field>
            <field name="arch" type="xml">
                <xpath expr="//filter[@name='inactive']" position="after">
                    <separator/>
                    <filter string="Participants formations"
                            name="training_participants"
                            domain="[('is_training_participant', '=', True)]"/>
                    <filter string="Avec handicap"
                            name="with_disability"
                            domain="[('has_disability', '=', True)]"/>
                </xpath>
            </field>
        </record>

        <!-- Action pour voir uniquement les participants -->
        <record id="action_res_partner_participants" model="ir.actions.act_window">
            <field name="name">Participants formation</field>
            <field name="res_model">res.partner</field>
            <field name="view_mode">tree,form</field>
            <field name="domain">[('is_training_participant', '=', True)]</field>
            <field name="context">{'default_is_training_participant': True}</field>
            <field name="search_view_id" ref="base.view_res_partner_filter"/>
        </record>

    </data>
</odoo>